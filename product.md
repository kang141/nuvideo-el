# ğŸ¬ Electron å½•å±äº§å“æ•´ä½“æ–¹æ¡ˆï¼ˆäº§å“çº§ï¼‰

## ä¸€ã€æ€»ä½“åŸåˆ™ï¼ˆå…ˆå®šæ­»ï¼‰

> **å½•åˆ¶åªåšé‡‡é›†
> ä½“éªŒæ¥è‡ªåæœŸ
> é€»è¾‘åœ¨æ¨¡å‹å±‚
> FFmpeg åªè´Ÿè´£è¾“å‡º**

åªè¦ä½ ä¸è¿èƒŒè¿™ 4 å¥è¯ï¼Œåé¢ä¸ä¼šè¿”å·¥ã€‚

---

## äºŒã€æ•´ä½“æ¶æ„ï¼ˆå…¨é“¾è·¯ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Electron UI â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Recording Layer  â”‚  â† åªé‡‡é›†
â”‚ (Raw Capture)    â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Timeline Model   â”‚  â† å”¯ä¸€çœŸç›¸
â”‚ (Events / Graph) â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Preview Renderer â”‚  â† å¥¶æ²¹æ„Ÿ
â”‚ (Canvas / WebGL) â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Export Pipeline  â”‚  â† é«˜è´¨é‡
â”‚ (FFmpeg)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¸‰ã€æ¯ä¸€å±‚ã€Œå…·ä½“åšä»€ä¹ˆã€ï¼ˆé‡ç‚¹ï¼‰

---

## 1ï¸âƒ£ Recording Layerï¼ˆå½•åˆ¶å±‚ï¼‰

### ğŸ¯ ç›®æ ‡

> **ç¨³å®šã€å¹²å‡€ã€å¯é‡æ„**

### âœ… åšä»€ä¹ˆ

- æ¡Œé¢ / çª—å£åŸå§‹è§†é¢‘ï¼ˆ**æ”¯æŒ 4K 60fps**ï¼‰
- åŸå§‹éŸ³é¢‘ï¼ˆç³»ç»ŸéŸ³ + éº¦å…‹é£ç‹¬ç«‹è½¨é“ï¼‰
- **é¼ æ ‡æŒ‡é’ˆäº‹ä»¶åºåˆ—**ï¼ˆåæ ‡ + ç‚¹å‡»çŠ¶æ€ï¼Œå› ä¸º `desktopCapturer` é»˜è®¤ä¸å½•æŒ‡é’ˆï¼‰

### ğŸ›  æŠ€æœ¯ç­–ç•¥ï¼šæ€§èƒ½è‡ªé€‚åº”æ£€æµ‹

```ts
async function getOptimalCaptureSettings() {
  const cpuCores = os.cpus().length;
  const totalMem = os.totalmem();
  // 4K60 éœ€è¦å¼ºæ‚ç¡¬ä»¶ï¼Œ8 æ ¸ + 16G å†…å­˜æ˜¯åº•çº¿
  if (cpuCores >= 8 && totalMem > 16 * 1024 ** 3) {
    return { width: 3840, height: 2160, fps: 60 };
  }
  return { width: 1920, height: 1080, fps: 60 };
}
```

### âš ï¸ é¿å‘æŒ‡å—

- **æ–‡ä»¶ä½“ç§¯**ï¼š4K60 å½•åˆ¶ 10 åˆ†é’Ÿå¯èƒ½çªç ´ 10GBï¼Œéœ€åœ¨ UI æç¤ºç£ç›˜ç©ºé—´ã€‚
- **ç¼–ç å‹åŠ›**ï¼šè‹¥ç¼–ç å™¨æ‰å¸§ï¼Œéœ€è‡ªåŠ¨é™çº§åˆ° 1080pã€‚

---

## 2ï¸âƒ£ Timeline Modelï¼ˆæ ¸å¿ƒæ¨¡å‹å±‚ï¼‰

> **è¿™æ˜¯æ•´ä¸ªç³»ç»Ÿçš„å¿ƒè„ï¼Œå¿…é¡»å®ç°ã€Œå•ä¸€çœŸç›¸æºï¼ˆSingle Source of Truthï¼‰ã€**

### ğŸ¯ ç›®æ ‡

> **ç¡®ä¿ç®—æ³•åœ¨ä»»ä½•ç¯å¢ƒä¸‹è¾“å‡ºä¸€è‡´ï¼Œå½»åº•æ¶ˆé™¤é¢„è§ˆä¸äº§å‡ºä¸ä¸€è‡´ï¼ˆOOSï¼‰çš„é—®é¢˜**

### æ•°æ®ç»“æ„ & å…±äº«ç®—æ³•

```ts
/** æ ¸å¿ƒï¼šå•ä¸€çœŸç›¸æº */
interface RenderGraph {
  mouse: MouseEvent[];
  camera: {
    intents: CameraIntent[];
    algorithm: "spring" | "linear";
    springConfig?: { stiffness: number; damping: number };
  };
  audio?: {
    tracks: Array<{
      source: 'microphone' | 'system' | 'file';
      startTime: number;  // æ¯«ç§’çº§å¯¹é½
      volume: number;
    }>;
  };
  config: { ... };
}
```

/\*_ æ ¸å¿ƒè§£ç®—ï¼šå…±äº«çº¯å‡½æ•° _/
function computeCameraState(graph: RenderGraph, t: number): CameraState {
// é¢„è§ˆ (Preview) å’Œ å¯¼å‡º (Export) å¿…é¡»ä¸”åªèƒ½è°ƒç”¨è¿™ä¸ªå‡½æ•°æ¥è·å–ç‰©ç†çŠ¶æ€
// çº¯å‡½æ•°ç‰¹æ€§ï¼šç›¸åŒè¾“å…¥ï¼Œå¿…å¾—ç›¸åŒè¾“å‡º
}

### âœ… åˆæ ¼æ ‡å‡†

- **æ‰€æœ‰æ¸²æŸ“ä¿¡æ¯æºè‡ª RenderGraph**ï¼Œä¸¥ç¦åœ¨ç»„ä»¶ç”Ÿå‘½å‘¨æœŸä¸­å­˜å‚¨ç‹¬ç«‹æ¸²æŸ“çŠ¶æ€ã€‚
- **ç‰©ç†æ—¶é—´é©±åŠ¨**ï¼šä»¥æµ®ç‚¹æ¯«ç§’ `t` ä¸ºå”¯ä¸€ç´¢å¼•ï¼Œå…¼å®¹ä¸åŒå¸§ç‡é‡‡æ ·ã€‚

---

## 3ï¸âƒ£ Preview Rendererï¼ˆé¢„è§ˆå±‚ï¼‰

### ğŸ¯ ç›®æ ‡

> **ç»å¯¹çš„â€œå—æ§ç»„ä»¶â€ï¼Œä»…è´Ÿè´£â€œä» State åˆ° Pixelsâ€çš„æ˜ å°„**

### æ ¸å¿ƒè§„åˆ™

- **Read-only**ï¼šé¢„è§ˆå™¨åªæ¥æ”¶ `computeCameraState` çš„äº§å‡ºï¼Œä¸å¤„ç† `Intent`ã€‚
- **æ— çŠ¶æ€æ¸²æŸ“**ï¼šCanvas ç»˜å›¾é€»è¾‘ä¸ä¸šåŠ¡é€»è¾‘å½»åº•è§£è€¦ã€‚

### æ ¸å¿ƒç®—æ³•ï¼šSpring ç‰©ç†å¼•æ“

```ts
// è‡ªå®šä¹‰é˜»å°¼é…ç½®
const SMOOTH_CONFIG = { stiffness: 100, damping: 20 }; // Screen Studio é£æ ¼
const SNAPPY_CONFIG = { stiffness: 300, damping: 30 }; // Loom é£1æ ¼

function springInterpolate(current: State, target: Intent, dt: number) {
  // åŠ é€Ÿåº¦ = -k * ä½ç§» - d * é€Ÿåº¦
  // æ›´æ–°é€Ÿåº¦ & ä½ç½®ï¼ˆä½¿ç”¨åŠéšå¼æ¬§æ‹‰æˆ– Verlet ç§¯åˆ†ï¼‰
}

### äº¤äº’ç»†èŠ‚ï¼šé¼ æ ‡ç»˜åˆ¶

- **æŒ‡é’ˆæ•è·**ï¼šç”±äº `desktopCapturer` ä¸å½•åˆ¶ç³»ç»ŸæŒ‡é’ˆï¼Œéœ€å•ç‹¬è®°å½• `MouseEvent[]` åºåˆ—ã€‚
- **åŠ¨æ€ç»˜åˆ¶**ï¼šåœ¨ Canvas ä¸Šæ¨¡æ‹Ÿå…‰æ ‡ï¼Œæ”¯æŒâ€œé»„åœˆé«˜äº®â€ã€â€œç‚¹å‡»æ³¢çº¹â€ç­‰è‡ªå®šä¹‰ä¸»é¢˜ã€‚
- **åæ ‡è½¬æ¢**ï¼šå°†åŸå§‹å±å¹•åæ ‡è½¬æ¢ä¸ºåŸºäº `CameraState` çš„å±€éƒ¨ç”»é¢åæ ‡ã€‚

---

## 4ï¸âƒ£ Export Pipelineï¼ˆå¯¼å‡ºå±‚ï¼‰

### ğŸ¯ ç›®æ ‡

> **100% è¿˜åŸé¢„è§ˆæ•ˆæœï¼Œç¨³å®šä¸”å¯é¢„æµ‹**

### ç­–ç•¥ï¼šCanvas-to-FFmpeg (æ–¹æ¡ˆ B)

- **ä¸ºä»€ä¹ˆé€‰æ–¹æ¡ˆ B**ï¼šCanvas æ¸²æŸ“å¯ä»¥è½»æ¾å¤„ç†**å‡ ä¸‡æ¡é¼ æ ‡äº‹ä»¶**å’Œ**å¤æ‚çš„éŸ³è§†é¢‘æ··ç¼–**ï¼Œè€Œä¸ä¼šè®© FFmpeg å‘½ä»¤è¡Œå‚æ•°çˆ†ç‚¸ã€‚
- **æ··éŸ³é€»è¾‘**ï¼šFFmpeg é€šè¿‡ `-filter_complex "amix"` åˆå¹¶åŸå§‹ç³»ç»ŸéŸ³å’Œå½•åˆ¶çš„éº¦å…‹é£å£°é“ã€‚

### âœ… åˆæ ¼æ ‡å‡†

- **éŸ³ç”»åŒæ­¥**ï¼šå¯¼å‡ºè§†é¢‘çš„éŸ³ç”»åå·®æ§åˆ¶åœ¨ 30ms ä»¥å†…ï¼ˆä¸€å¸§å†…ï¼‰ã€‚
- **é¼ æ ‡ä¸æ»‘**ï¼šå¯¼å‡ºçš„é¼ æ ‡è½¨è¿¹ä¸ 60fps å¸§ç‡å®Œç¾åŒ¹é…ã€‚

---

## å››ã€æ ¸å¿ƒèƒ½åŠ› & éªŒæ”¶æ¸…å•ï¼ˆä½ ç…§ç€æ‰“å‹¾ï¼‰

### ğŸ¥ å½•åˆ¶

- [ ] **4K 60fps** æ€§èƒ½è‡ªé€‚åº”
- [ ] åŸå§‹ç³»ç»ŸéŸ³ + éº¦å…‹é£ç‹¬ç«‹å½•åˆ¶
- [ ] å®Œæ•´é¼ æ ‡äº‹ä»¶é‡‡é›†ï¼ˆä½ç½®+ç‚¹å‡»ï¼‰

### ğŸ ä½“éªŒ

- [ ] **Spring é˜»å°¼** é•œå¤´è·Ÿéš
- [ ] è‡ªå®šä¹‰é¼ æ ‡çš®è‚¤ï¼ˆé»„åœˆ/ç‚¹å‡»æ¶Ÿæ¼ªï¼‰
- [ ] å¤šæ¯”ä¾‹éšæ—¶åˆ‡æ¢

### ğŸ§  æ¶æ„

- [ ] å•ä¸€ RenderGraph ç³»ç»Ÿ
- [ ] **computeCameraState** å…±äº«è§£ç®—
- [ ] æ¯«ç§’çº§æ—¶é—´å‡†åˆ™

### ğŸ“¦ å¯¼å‡º

- [ ] **Canvas-to-FFmpeg** 100% ä¸€è‡´å¯¼å‡º
- [ ] MP4 / GIF ç‹¬ç«‹æ¨¡æ¿
- [ ] å¯¼å‡ºæ—¶è‡ªåŠ¨æ··éŸ³


---
```

src/
â”œâ”€â”€ types/ # ç±»å‹å®šä¹‰ï¼ˆé›†ä¸­ç®¡ç†ï¼‰
â”‚ â”œâ”€â”€ index.ts # ç»Ÿä¸€å¯¼å‡º
â”‚ â”œâ”€â”€ render-graph.ts # RenderGraph æ ¸å¿ƒæ•°æ®ç»“æ„
â”‚ â”œâ”€â”€ camera.ts # Camera Intent/State
â”‚ â”œâ”€â”€ mouse.ts # é¼ æ ‡äº‹ä»¶
â”‚ â””â”€â”€ audio.ts # éŸ³é¢‘è½¨é“
â”‚
â”œâ”€â”€ core/ # æ ¸å¿ƒè§£ç®—é€»è¾‘ï¼ˆçº¯å‡½æ•°ï¼‰
â”‚ â”œâ”€â”€ index.ts # ç»Ÿä¸€å¯¼å‡º
â”‚ â”œâ”€â”€ camera-solver.ts # computeCameraState å®ç°
â”‚ â”œâ”€â”€ spring-physics.ts # Spring ç‰©ç†å¼•æ“
â”‚ â””â”€â”€ timeline.ts # Timeline å·¥å…·å‡½æ•°
â”‚
â”œâ”€â”€ renderer/ # æ¸²æŸ“å±‚ï¼ˆåªè¯»ï¼Œæ— çŠ¶æ€ï¼‰
â”‚ â”œâ”€â”€ index.ts
â”‚ â”œâ”€â”€ preview-canvas.ts # Canvas é¢„è§ˆæ¸²æŸ“å™¨
â”‚ â””â”€â”€ mouse-painter.ts # é¼ æ ‡ç»˜åˆ¶é€»è¾‘
â”‚
â”œâ”€â”€ export/ # å¯¼å‡ºç®¡çº¿
â”‚ â”œâ”€â”€ index.ts
â”‚ â”œâ”€â”€ canvas-to-ffmpeg.ts # æ–¹æ¡ˆ B å®ç°
â”‚ â””â”€â”€ audio-mixer.ts # éŸ³é¢‘æ··åˆ
â”‚
â”œâ”€â”€ recorder/ # å½•åˆ¶å±‚
â”‚ â”œâ”€â”€ index.ts
â”‚ â”œâ”€â”€ screen-capture.ts # desktopCapturer å°è£…
â”‚ â”œâ”€â”€ mouse-tracker.ts # é¼ æ ‡äº‹ä»¶é‡‡é›†
â”‚ â””â”€â”€ audio-capture.ts # éŸ³é¢‘é‡‡é›†
â”‚
â””â”€â”€ components/ # React ç»„ä»¶
â”œâ”€â”€ RecordButton.tsx
â”œâ”€â”€ PreviewCanvas.tsx
â””â”€â”€ ExportDialog.tsx
è®¾è®¡åŸåˆ™

1. ç±»å‹é›†ä¸­ç®¡ç†
   æ‰€æœ‰ interface å’Œ type å®šä¹‰åœ¨ src/types/ ä¸­ã€‚
   æŒ‰ä¸šåŠ¡é¢†åŸŸæ‹†åˆ†æ–‡ä»¶ï¼ˆcameraã€mouseã€audio ç­‰ï¼‰ã€‚
   é€šè¿‡ types/index.ts ç»Ÿä¸€å¯¼å‡ºï¼Œé¿å…å¾ªç¯ä¾èµ–ã€‚
2. æ ¸å¿ƒé€»è¾‘éš”ç¦»
   src/core/ åªåŒ…å«çº¯å‡½æ•°ï¼Œä¸ä¾èµ– DOMã€Canvasã€Reactã€‚
   å¯ä»¥å•ç‹¬è¿›è¡Œå•å…ƒæµ‹è¯•ã€‚
   Preview å’Œ Export éƒ½è°ƒç”¨è¿™é‡Œçš„å‡½æ•°ã€‚
3. æ¸²æŸ“å±‚æ— çŠ¶æ€
   src/renderer/ åªè´Ÿè´£"State â†’ Pixels"çš„æ˜ å°„ã€‚
   ä¸åŒ…å«ä»»ä½•ä¸šåŠ¡é€»è¾‘æˆ–çŠ¶æ€æ¨å¯¼ã€‚
4. ç»„ä»¶åŒ–
   React ç»„ä»¶åªè´Ÿè´£ UI äº¤äº’å’Œç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚
   ä¸šåŠ¡é€»è¾‘é€šè¿‡è°ƒç”¨ core å’Œ recorder æ¨¡å—å®ç°ã€‚
